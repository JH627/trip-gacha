<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.gacha.model.dao.SpotDao">
    <resultMap id="spotResultMap" type="com.gacha.model.dto.response.trip.SpotInfo">
        <id property="spotId" column="spot_id"/>
        <result property="destination" column="destination_name"/>
        <result property="name" column="name"/>
        <result property="content" column="content"/>
        <result property="img" column="img"/>
        <result property="address" column="address"/>
        <result property="likes" column="likes"/>
        <result property="stars" column="stars"/>
        <result property="category" column="category_name"/>
        <result property="phone" column="phone"/>
        <result property="workTime" column="work_time"/>
        <result property="marked" column="is_bookmarked"/>
    </resultMap>

    <select id="selectAll" resultMap="spotResultMap">
        SELECT s.*, 
               d.name as destination_name,
               c.name as category_name,
               CASE WHEN b.bookmark_id IS NOT NULL THEN true ELSE false END as is_bookmarked
        FROM spots s
        LEFT JOIN destinations d ON s.destination_id = d.destination_id
        LEFT JOIN categories c ON s.category_id = c.category_id
        LEFT JOIN bookmarks b ON s.spot_id = b.spot_id AND b.user_id = #{userId}
    </select>

    <select id="isBookmarked" resultType="boolean">
        SELECT EXISTS (
            SELECT 1 FROM bookmarks 
            WHERE user_id = #{userId} AND spot_id = #{spotId}
        )
    </select>

    <insert id="addBookmark">
        INSERT INTO bookmarks (user_id, spot_id)
        VALUES (#{userId}, #{spotId})
    </insert>

    <delete id="deleteBookmark">
        DELETE FROM bookmarks 
        WHERE user_id = #{userId} AND spot_id = #{spotId}
    </delete>
</mapper>
